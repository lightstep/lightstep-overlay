{"version":3,"sources":["../src/overlay.js"],"names":[],"mappings":"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","file":"overlay.js","sourcesContent":["import Tracer from 'opentracing';\n\n//\n// Provide an HTML debug overlay DIV with status information about the running\n// cruntime.\n//\nlet gDebugOverlayEnabled = false;\n\n// NOTE: this relies directly on the LightStep implementation and not on the\n// OpenTracing APIs\nupdateDebugOverlay(Tracer.imp(), true);\n\nconst HOST_DIV_ID = 'lightstep_overlay';\n\nfunction updateDebugOverlay(tracer, enabled) {\n    // Ignore the case of debugging being enabled then disabled for\n    // reasons of engineering prioritization (not correctness!).\n    if (!enabled) {\n        return;\n    }\n    if (!tracer) {\n        return;\n    }\n    if (gDebugOverlayEnabled) {\n        return;\n    }\n\n    gDebugOverlayEnabled = true;\n\n    tracer.on('report', (report) => {\n        let spans = report.span_records;\n        if (!spans || spans.length === 0) {\n            return;\n        }\n\n        let opts = tracer.options();\n        let kMaxSpans = 4;\n        let totalLinks = 0;\n\n        // Make a guess about whether we are reporting to a dev instance or not\n        // based on the ports being used.\n        let url;\n        if (opts.collector_port >= 9997 && opts.collector_port <= 9998) {\n            url = `http://${window.location.hostname}:${window.location.port}/${opts.access_token}/`;\n        } else {\n            let host = opts.collector_host;\n            if (host.match(/^collector[.-]/)) {\n                host = host.replace(/^collector([.-])/, 'app$1');\n            }\n            url = `https://${host}/${opts.access_token}/`;\n        }\n\n        // Check if the element is there, as some in-page script might have\n        // cleared the BODY, etc.\n        let count;\n        let overlay = document.getElementById(HOST_DIV_ID);\n        if (!overlay) {\n            let container = document.createElement('a');\n            container.href = `${url}latest?q=tracer.guid:${spans[0].runtime_guid}`;\n            container.style.position = 'fixed';\n            container.style.bottom = '2em';\n            container.style.right = '2em';\n            container.style.width = '3em';\n            container.style.height = '3em';\n            container.style.borderRadius = '3em';\n            container.style.cursor = 'pointer';\n            container.style.background = 'rgb(0, 163, 255)';\n            container.style.boxShadow = '0 0 0 1px #c4c4c4, 0 2px 20px 0 #e2e2e2';\n            container.style.transition = '.2s all';\n            container.style.transform = 'scale(0)';\n            container.style.opacity = '0';\n\n\n            let btn = document.createElement('div');\n            btn.style.width = '100%';\n            btn.style.height = '100%';\n            btn.style.display = 'block';\n            btn.style.borderRadius = '3em';\n            btn.style.background = 'linear-gradient(to bottom right,#00d6ff,#3b6fcb 90%)';\n            btn.style.opacity = '0';\n            btn.style.boxShadow = '0 0 0 0 transparent';\n            btn.style.transition = '.5s all';\n\n            let badge = document.createElement('div');\n            badge.style.width = '.75em';\n            badge.style.height = '.75em';\n            badge.style.borderRadius = '1em';\n            badge.style.background = 'red';\n            badge.style.position = 'absolute';\n            badge.style.top = '0em';\n            badge.style.right = '0em';\n\n\n            let logo = document.createElement('img');\n            logo.src = 'http://imgur.com/brQx4rK.png';\n            logo.style.width = '2em';\n            logo.style.position = 'absolute';\n            logo.style.top = '.925em';\n            logo.style.left = '.5em';\n\n            count = document.createElement('div');\n            count.style.fontSize = '.75em';\n            count.style.position = 'absolute';\n            count.style.top = '-.4rem';\n            count.style.right = '-.4rem';\n            count.style.minWidth = '1.2rem';\n            count.style.height = '1.2rem';\n            count.style.paddingTop = '.2rem';\n            count.style.borderRadius = '1.2em';\n            count.style.textAlign = 'center';\n            count.style.backgroundColor = '#ff7a7a';\n            count.style.color = '#FFF';\n\n            container.onmouseenter = function (e) {\n                btn.style.background = 'linear-gradient(to bottom right,#00d6ff,#3b6fcb 90%)';\n                btn.style.boxShadow = 'inset 0 0 0 2px #FFF, inset 0 0 0 3px rgb(29, 184, 228)';\n                btn.style.opacity = '1';\n                container.style.boxShadow = 'rgb(196, 196, 196) 0px 0px 0px 1px, rgb(184, 184, 184) 0px 4px 30px 0px';\n                container.style.opacity = '1';\n                count.innerHTML = 'x';\n            };\n\n            container.onmouseleave = function (e) {\n                btn.style.boxShadow = '0 0 0 0 transparent';\n                btn.style.opacity = '0';\n                container.style.boxShadow = '0 0 0 1px #c4c4c4, 0 2px 20px 0 #e2e2e2';\n                container.style.opacity = '.9';\n                count.innerHTML = totalLinks;\n            };\n\n            count.onclick = function (e) {\n                e.preventDefault();\n                e.stopPropagation();\n\n                container.style.transform = 'scale(0)';\n                container.style.opacity = '0';\n            };\n\n            container.appendChild(btn);\n            container.appendChild(logo);\n            container.appendChild(count);\n\n            overlay = document.createElement('div');\n            overlay.id = HOST_DIV_ID;\n            let close = document.createElement('div');\n            let link = document.createElement('a');\n            link.href = url;\n            let title = document.createElement('div');\n            title.appendChild(link);\n            title.appendChild(close);\n            overlay.appendChild(title);\n\n            document.body.appendChild(overlay);\n            document.body.appendChild(container);\n\n            // Once all that stuff is done\n            // Note the getComputedStyle() call is necessary to force the DOM\n            // to update the element so the animation looks correct\n            container.style.opacity = '0';\n            window.getComputedStyle(container).opacity; // eslint-disable-line no-unused-expressions\n\n            container.style.transform = 'scale(1)';\n            container.style.opacity = '1';\n        }\n\n\n        for (let i = 0; i < overlay.childNodes.length; i++) {\n            let child = overlay.childNodes[i];\n            if (child.className === 'lightstep_span') {\n                totalLinks++;\n            }\n        }\n        // If we've already added kMaxSpans+1 lines below the\n        // 'header', then don't add anything else.\n        if (totalLinks > kMaxSpans) {\n            return;\n        }\n\n        // Do a primitive trace joining here: only show one link per\n        // trace (i.e. one link per set of spans that will be\n        // combined). We make the (possibly not true) assumptions that\n        // all spans in a trace will arrive in the same event and that\n        // all span share a join id (just to keep things simple).\n        let joinedSpans = [];\n        for (let i = 0; i < spans.length; i++) {\n            joinedSpans.push({\n                summary         : spans[i].span_name,\n                oldest_micros   : spans[i].oldest_micros,\n                youngest_micros : spans[i].youngest_micros,\n                span_guid       : spans[i].span_guid,\n            });\n        }\n        for (let i = 0; i < joinedSpans.length; i++) {\n            for (let j = i + 1; j < joinedSpans.length; j++) {\n                if ((joinedSpans[j].oldest_micros <= joinedSpans[i].youngest_micros &&\n                     joinedSpans[j].youngest_micros >= joinedSpans[i].oldest_micros)) {\n                    if (joinedSpans[j].oldest_micros < joinedSpans[i].oldest_micros) {\n                        joinedSpans[i].summary = `${joinedSpans[j].summary}, ${joinedSpans[i].summary}`;\n                        joinedSpans[i].oldest_micros = joinedSpans[j].oldest_micros;\n                    } else {\n                        joinedSpans[i].summary += `, ${joinedSpans[j].summary}`;\n                    }\n                    if (joinedSpans[j].youngest_micros > joinedSpans[i].youngest_micros) {\n                        joinedSpans[i].youngest_micros = joinedSpans[j].youngest_micros;\n                    }\n                    joinedSpans[j] = joinedSpans[joinedSpans.length - 1];\n                    joinedSpans = joinedSpans.slice(0, joinedSpans.length - 1);\n                    j = i;\n                }\n            }\n        }\n\n        for (let i = 0; i < joinedSpans.length && totalLinks <= kMaxSpans; i++) {\n            totalLinks++;\n            count.innerHTML = totalLinks;\n        }\n    });\n}\n"]}